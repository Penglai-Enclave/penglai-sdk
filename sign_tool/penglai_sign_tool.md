# penglai sign tool

### 1. 编译：

在项目根目录下执行以下命令，编译出的`penglai_sign`位于`sign_tool`目录下，`penglai_sign`可以在本地运行。
```shell
chmod +x ./sdk/build_sign_tool.sh
./sdk/build_sign_tool.sh
```



### 2. 使用说明：

使用`penglai_sign` 有下列参数，结合openssl 3.0.0版本可进行单步签名，两步签名，签名材料生成，以及转录签名后的ELF文件中的签名信息，分别对应以下命令。

```
"\nUsage: penglai_sign <commands> [options] file...\n"\
    "Commands:\n"\
    "   sign                    Sign the enclave using the private key\n"\
    "   gendata                 Generate enclave signing material to be signed\n"\
    "   catsig                  Generate the signed enclave with the input signature file, the\n"\
    "                           public key and the enclave signing material\n"\
    "   dump                    Dump metadata information for a signed enclave file\n"\
    "Options:\n"\
    "   -enclave                Specify the enclave file to be signed or already signed\n"\
    "                           It is a required option for the four commands\n"\
    "   -key                    Specify the key file\n"\
    "                           It is a required option for \"sign\" and \"catsig\"\n"\
    "   -out                    Specify the output file\n"\
    "                           It is a required option for \"sign\", \"gendata\" and \"catsig\"\n"\
    "   -sig                    Specify the signature file for the enclave signing material\n" \
    "                           It is a required option for \"catsig\"\n"\
    "   -unsigned               Specify the enclave signing material generated by \"gendata\"\n" \
    "                           It is a required option for \"catsig\"\n" \
    "   -dumpfile               Specify a file to dump metadata information (text format)\n" \
    "                           It is a required option for \"dump\"\n" \
    "Run \"penglai_sign -help\" to get this help and exit.\n"
```

#### 2.1 单步签名

Step 1: 单步签名需要应用开发者的SM2私钥，私钥格式支持PEM文件格式。可通过以下命令使用openssl 3.0版本生成。若未安装openssl 或其他命令行工具，可跳过此步，使用`sign_tool` 目录下的`SM2PrivateKey.pem` 私钥文件进行尝试。

```
# 生成SM2椭圆曲线参数，保存在 ecp.pem 中
openssl genpkey -genparam -algorithm EC -out ecp.pem \
        -pkeyopt ec_paramgen_curve:sm2 \
        -pkeyopt ec_param_enc:named_curve

# 使用SM2参数生成私钥
openssl genpkey -paramfile ecp.pem -out SM2PrivateKey.pem
```

Step 2: 使用`penglai_sign` 生成签名文件。

```
./penglai_sign sign -enclave prime -key SM2PrivateKey.pem -out prime-signed
```

#### 2.2 签名信息转录

Method 1: 在生成签名文件的过程中，可使用`-dumpfile` 参数指定要将签名信息转录到的文件，如单步签名中：

```
./penglai_sign sign -enclave prime -key SM2PrivateKey.pem -out prime-signed -dumpfile dump-file
```

Method 2: 使用dump命令转录已被签名的文件中的签名信息：

```
./penglai_sign dump -enclave prime-signed -dumpfile dump-file
```

通过如上方法可得到长度为160 byte 的文件`dump-file` ，其中包含enclave的元数据信息（配置、测量及签名等），可用于向"蓬莱"或第三方认证机构提交白名单申请。为了确认飞地开发者身份，用于审计和追责，蓬莱的`launch enclave` 在生产模式下只允许启动白名单中开发者的飞地。

#### 2.3 两步签名

两步签名考虑到开发者或应用服务提供商的私钥需要严格保护，不能以明文用于签名工具的输入。

Step 1: 可用openssl 3.0得到SM2密钥对。

```
# 生成SM2椭圆曲线参数，保存在 ecp.pem 中
openssl genpkey -genparam -algorithm EC -out ecp.pem \
        -pkeyopt ec_paramgen_curve:sm2 \
        -pkeyopt ec_param_enc:named_curve

# 使用SM2参数生成私钥
openssl genpkey -paramfile ecp.pem -out SM2PrivateKey.pem

# 使用SM2私钥生成公钥
openssl ec -in SM2PrivateKey.pem -pubout -out SM2PublicKey.pem
```
Step 2: 需要得到待签名enclave 的签名材料，在受保护的环境中如HSM（硬件安全模块）中用私钥进行签名，最后用公钥和签名后的材料来得到签名文件。
```
# 使用签名工具得到待签名enclave 的签名材料
./penglai_sign gendata -enclave prime -out metadata-file

# 通过openssl 3.0用私钥进行签名（验签），此处someid是SM2国标中规定的签名者id，可用邮箱
openssl pkeyutl -sign -in metadata-file -inkey SM2PrivateKey.pem -out sig-file -rawin -digest sm3 \
    -pkeyopt distid:someid
openssl pkeyutl -verify -in metadata-file -inkey SM2PrivateKey.pem -sigfile sig-file \
    -rawin -digest sm3 -pkeyopt distid:someid
```

Step 3: 使用签名文件和公钥为原enclave 文件添加签名信息 ，该命令需要输入原enclave 文件对签名材料进行验证

```
./penglai_sign catsig -enclave prime -key SM2PublicKey.pem -unsigned metadata-file -sig sig-file \
    -out prime-signed
```

***Note:*** 目前，蓬莱内部的密码算法使用gm算法库，经测试该算法库无法验证使用openssl 的签名，认为是密码库内部实现上有差别（已排除密钥、摘要输入格式的问题），所以两步签名得到的签名文件无法通过Secure Monitor 的验证。两步签名的正确性留给Secure Monitor移植openssl 密码库后解决。

### 3. 视频Demo展示

我们提供了使用单步签名的演示视频，请参考[链接](https://ipads.se.sjtu.edu.cn:1313/f/1ceba27708c74cbab4c0/)。

### 4. 补充openssl 的说明 {#section4}

目前penglai sign_tool对 openssl 的依赖在于需要用openssl 的PEM decoder和DER decoder，相应逻辑涉及base64转byte array，提取算法国际标号等。

用openssl 签名（验证）hash：（SM2的hash 要求为32 位byte array）

```
openssl pkeyutl -sign -inkey eckey.pem -in hash-file -out sig-file

openssl pkeyutl -verify -in hash-file -pubin -inkey pub_key.pem -sigfile sig-file
```

### 5. 签名和report的关系

签名将会写入enclave中名为`.note.penglaimeta`段中。写入的数据布局如下：

```c
typedef struct _enclave_css_t {        /* 160 bytes */
    unsigned char enclave_hash[HASH_SIZE];          /* (32) */
    // enclave_hash是enclave的度量值
    unsigned char signature[SIGNATURE_SIZE];        /* (64) */
    // signature是对enclave_hash的签名
    unsigned char user_pub_key[PUBLIC_KEY_SIZE];    /* (64) */
    // user_pub_key是签名者公钥，用于验证签名的合法性
} enclave_css_t;
```

attest会为enclave生成一个report，其结构如下：

```c
struct sm_report_t
{
  unsigned char hash[HASH_SIZE]; // secure monitor的哈希
  unsigned char signature[SIGNATURE_SIZE]; // hash的签名
  unsigned char sm_pub_key[PUBLIC_KEY_SIZE]; // secure monitor的公钥，用于验证签名
};

struct enclave_report_t
{
  unsigned char hash[HASH_SIZE]; // enclave的度量值
  unsigned char signature[SIGNATURE_SIZE]; // 用secure monitor私钥对hash的签名
  uintptr_t nonce; // 随机数，需要参与hash计算
};

struct report_t
{
  struct sm_report_t sm;
  struct enclave_report_t enclave;
  unsigned char dev_pub_key[PUBLIC_KEY_SIZE]; // 设备的公钥，用于验证设备身份
};
```

签名和report的关系：sign tool 和 secure monitor 计算的enclave的度量值应该相同，即需要满足`enclave_css_t.enclave_hash == enclave_report_t.hash`。
